name: Test Database Backup

# This is a test version that runs on the feature branch
# Delete this file after testing, the main backup-database.yml will run on master

on:
  push:
    branches: [ claude/add-members-crud-screen-016kNmYqQ7VN5PKhqUn4mj81 ]
    paths:
      - '.github/workflows/backup-database-test.yml'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
    - name: Set backup timestamp
      id: timestamp
      run: |
        TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        echo "date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

    - name: Backup database from VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "Starting database backup..."
          echo "======================================"

          # Show all running containers for debugging
          echo "Running containers:"
          docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Image}}"
          echo "======================================"

          # Try multiple naming patterns for the container
          CONTAINER_ID=$(docker ps -q -f name=bcfk-bcfk-1)
          if [ -z "$CONTAINER_ID" ]; then
            CONTAINER_ID=$(docker ps -q -f name=bcfk_bcfk_1)
          fi
          if [ -z "$CONTAINER_ID" ]; then
            CONTAINER_ID=$(docker ps -q -f name=data-bcfk-1)
          fi
          if [ -z "$CONTAINER_ID" ]; then
            CONTAINER_ID=$(docker ps -q -f name=data_bcfk_1)
          fi
          # Fallback: try to find any container with "bcfk" in the name
          if [ -z "$CONTAINER_ID" ]; then
            CONTAINER_ID=$(docker ps -q -f name=bcfk | head -1)
          fi

          if [ -z "$CONTAINER_ID" ]; then
            echo "Error: BCFK container not found!"
            echo "Please check the container name in the output above."
            exit 1
          fi

          echo "Found container: $CONTAINER_ID"
          CONTAINER_NAME=$(docker ps --filter id=$CONTAINER_ID --format "{{.Names}}")
          echo "Container name: $CONTAINER_NAME"

          # Verify database exists in container
          echo "Checking if database exists in container..."
          if ! docker exec $CONTAINER_ID test -f /app/data/planning.db; then
            echo "Error: Database file /app/data/planning.db not found in container!"
            echo "Contents of /app/data/ directory:"
            docker exec $CONTAINER_ID ls -lah /app/data/ || echo "Could not list directory"
            exit 1
          fi

          echo "Database file found in container"

          # Create backup directory if it doesn't exist
          mkdir -p /tmp/bcfk-backups

          # Copy database from container to host
          echo "Copying database from container to host..."
          docker cp $CONTAINER_ID:/app/data/planning.db /tmp/bcfk-backups/planning-${{ steps.timestamp.outputs.timestamp }}.db

          # Verify backup was created
          if [ ! -f "/tmp/bcfk-backups/planning-${{ steps.timestamp.outputs.timestamp }}.db" ]; then
            echo "Error: Backup file was not created"
            exit 1
          fi

          # Get file size for verification
          echo "Backup file created successfully:"
          ls -lh /tmp/bcfk-backups/planning-${{ steps.timestamp.outputs.timestamp }}.db

          echo "======================================"
          echo "Database backup completed successfully!"

    - name: Download backup from VPS
      run: |
        # Setup SSH key
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
        chmod 600 ~/.ssh/vps_key

        # Add VPS to known hosts to avoid prompt
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

        # Download the backup using scp
        scp -i ~/.ssh/vps_key \
          -o StrictHostKeyChecking=no \
          ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/tmp/bcfk-backups/planning-${{ steps.timestamp.outputs.timestamp }}.db \
          ./planning-${{ steps.timestamp.outputs.timestamp }}.db

        # Cleanup SSH key
        rm -f ~/.ssh/vps_key

        echo "Backup downloaded successfully"

    - name: Verify downloaded backup
      run: |
        BACKUP_FILE="planning-${{ steps.timestamp.outputs.timestamp }}.db"

        if [ ! -f "$BACKUP_FILE" ]; then
          echo "Error: Backup file not found after download"
          exit 1
        fi

        # Check file size (should be > 0 bytes)
        FILE_SIZE=$(stat -f%z "$BACKUP_FILE" 2>/dev/null || stat -c%s "$BACKUP_FILE" 2>/dev/null)

        if [ "$FILE_SIZE" -eq 0 ]; then
          echo "Error: Backup file is empty"
          exit 1
        fi

        echo "Backup file size: $FILE_SIZE bytes"

        # Verify it's a valid SQLite database
        if command -v sqlite3 &> /dev/null; then
          sqlite3 "$BACKUP_FILE" "SELECT count(*) FROM sqlite_master;" > /dev/null
          echo "SQLite database integrity check passed"
        fi

    - name: Upload backup as artifact
      uses: actions/upload-artifact@v4
      with:
        name: bcfk-database-backup-test-${{ steps.timestamp.outputs.timestamp }}
        path: planning-${{ steps.timestamp.outputs.timestamp }}.db
        retention-days: 7
        if-no-files-found: error

    - name: Cleanup VPS temporary files
      if: always()
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Keep only the last 7 days of local backups on VPS
          find /tmp/bcfk-backups -name "planning-*.db" -type f -mtime +7 -delete
          echo "VPS cleanup completed"

    - name: Test successful
      run: |
        echo "âœ… Backup test completed successfully!"
        echo "The main workflow (backup-database.yml) will run automatically on master branch."
        echo "You can delete backup-database-test.yml after verifying this works."
